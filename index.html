<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    <title>Are We ESM Yet?</title>
    <style type="text/css">
      body {
        text-align: center;
      }
      #status {
        font-size: 2rem;
      }
      #chart {
        width: 80vw;
        height: 30vh;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <h1>Are We ESM Yet?</h1>
    <div id="status">Loading ....</div>
    <canvas id="chart"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
      function circleAPI(path) {
        return fetch(`https://circleci.com/api/v2${path}`).then(r => r.json());
      }
      function updateStatus(status) {
        document.getElementById('status').textContent = status;
      }

      function displayStatus(results) {
        const { lastWorkflow, failed, total } = results[results.length - 1];
        if (lastWorkflow.status === 'failed') {
          updateStatus(`No (last build was ${lastWorkflow.status}) ${failed}/${total} (at least) failed`);
        } else {
          updateStatus(`Maybe (last build was ${lastWorkflow.status})`);
        }
      }

      function displayChart(results) {
        const ctx = document.getElementById('chart');

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: results.map((r) => r.lastWorkflow.created_at),
            datasets: [{
              label: 'Number of failed tests',
              data: results.map((r) => r.failed),
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      async function getTestResultForPipeline(project, pipelineId) {
        const workflows = await circleAPI(`/pipeline/${pipelineId}/workflow`);
        const lastWorkflow = await circleAPI(`/workflow/${workflows.items[0].id}`);
        const jobs = await circleAPI(`/workflow/${workflows.items[0].id}/job`);
        const apiJob = jobs.items.find((i) => i.name === 'api_build_and_test');
        if (apiJob && apiJob.job_number) {
          const tests = await circleAPI(`/project/gh/${project}/${apiJob.job_number}/tests`);
          const nbFailed = tests.items.filter((i) => i.result !== 'success').length;
          return { lastWorkflow, failed: nbFailed, total: tests.items.length };
        } else {
          return { lastWorkflow, failed: -1, total: -1 };
        }
      }

      async function areWeESMYet() {
        const branch = "pix-7202-migrate-api-module-from-cjs-to-esm";
        const project = "1024pix/pix";
        const pipelines = await circleAPI(`/project/gh/${project}/pipeline?branch=${branch}`);
        const lastPipelines = pipelines.items.reverse();
        const results = await Promise.all(lastPipelines.map(({ id }) => {
          return getTestResultForPipeline(project, id);
        })).then((result) => {
            return result
              .filter(r => r.failed !== -1)
              .filter(r => !['canceled', 'failing'].includes(r.lastWorkflow.status));
        });

        displayStatus(results);
        displayChart(results);
      }
      areWeESMYet();
    </script>
  </body>
</html>
